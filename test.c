#include <stdio.h>
#include <time.h>
#include <limits.h>
#include <assert.h>

#include "tm.h"

#define MAX_STEPS (INT_MAX >> 4)

double seconds(clock_t t1, clock_t t0) {
	return ((double) (t1 - t0)) / CLOCKS_PER_SEC;
}

struct test_case_t {
	char *txt;
	int steps;
	int nonzero;
};

const struct test_case_t TEST_CASES[];
const int N_TEST_CASES;

void verify_test_cases() {
	for (int i = 0; i < N_TEST_CASES; i++) {
		const struct test_case_t *const tcase = TEST_CASES + i;

		clock_t t = clock();
		struct tm_def_t *def = tm_def_parse(tcase->txt);
		printf("Parsed in %fs\n", seconds(clock(), t));

		printf("%s\n", tcase->txt);
		tm_def_print(def);

		t = clock();
		struct tm_run_t *run = tm_run_init(def);
		printf("Initialized in %fs\n", seconds(clock(), t));

		t = clock();
		tm_run_steps(run, MAX_STEPS);
		printf("Ran %d steps in %fs\n", run->steps, seconds(clock(), t));

		assert(run->steps == tcase->steps);
		printf("Test case %d/%d is OK!\n", i, N_TEST_CASES);

		tm_run_free(run);
		tm_def_free(def);
	}
}

int main(int _argc, char **_argv) {
	printf("Verifying test cases...\n");	
	verify_test_cases();
	return 0;
}


/* A list of small test cases taken from wiki.bbchallenge.org
 */
const struct test_case_t TEST_CASES[] = {
	// BB(3)
	{"1RB1RZ_1LB0RC_1LC1LA", 21, 5},
	{"1RB1RZ_0LC0RC_1LC1LA", 20, 5},
	{"1RB1LA_0RC1RZ_1LC0LA", 20, 5},
	{"1RB1RA_0RC1RZ_1LC0LA", 19, 5},
	{"1RB0RA_0RC1RZ_1LC0LA", 19, 4},
	{"1RB0LC_1LA1RZ_1RC1RB", 18, 5},
	{"1RB0LB_0RC1RC_1LA1RZ", 18, 5},
	{"1RB1LB_0RC1RZ_1LC0LA", 18, 4},
	{"1RB0LB_0RC1RZ_1LC0LA", 18, 3},
	{"1RB1RZ_0RC0RC_1LC1LA", 17, 5},
	{"1RB1RZ_0RC---_1LC0LA", 17, 4},
	{"1RB1LC_0LC1RA_1RZ1LA", 16, 5},
	{"1RB0LC_1LC1RB_1RZ1LA", 16, 5},
	{"1RB1LA_0LA1RC_1RA1RZ", 15, 5},
	{"1RB1LA_0LA1RC_0RB1RZ", 15, 4},
	{"1RB0LC_1RC1RZ_1LA0RB", 15, 4},
	{"1RB0RB_0LC1RZ_1RA1LC", 15, 3},
	{"1RB1RZ_0RC1RB_1LC1LA", 14, 6},
	{"1RB1RZ_1LB0LC_1RA1RC", 14, 5},
	{"1RB1RZ_0LC1RA_1LA1LB", 14, 5},
	{"1RB1RZ_1LC1RA_1RC0LB", 14, 4},
	{"1RB1RZ_1LB0LC_1RA0RC", 14, 3},
	{"1RB1RZ_0LC0RB_1LA1LC", 14, 3},
	{"1RB0RB_1LC1RZ_0LA1RA", 14, 3},
	{"1RB1RZ_0LC0RA_1RA1LB", 14, 2},
	// BB(2,3)
	{"1RB2LB1RZ_2LA2RB1LB", 38, 9},
	{"1RB0LB1RZ_2LA1RB1RA", 29, 8},
	{"1RB2LA1RZ_1LB1LA0RA", 26, 6},
	{"1RB1LA1LB_0LA2RA1RZ", 26, 6},
	{"1RB1LB1RZ_2LA2RB1LB", 24, 7},
	{"1RB2LA1RZ_0LB1LA0RA", 22, 4},
	{"1RB2RB1RZ_1LB1RA0LA", 21, 4},
	{"1RB2LA2RB_1LA1RZ1RA", 20, 6},
	{"1RB2LA1RZ_2LA2RB1LB", 20, 6},
	{"1RB2LA0RB_1LA1RZ1RA", 20, 5},
	{"1RB0LB1RZ_2LA2LB1RA", 19, 7},
	{"1RB0RB1RZ_1LB2RA1LA", 19, 6},
	{"1RB2LB1LA_2LA1RZ2RB", 18, 7},
	{"1RB1LB2LA_1LA2RB1RZ", 18, 7},
	{"1RB2LB2LA_2LA1RZ0RA", 18, 6},
	{"1RB2LA1RZ_1LB1RA2RB", 18, 6},
	{"1RB2LB1RZ_2LA1RA0LB", 18, 5},
	{"1RB0RB1RZ_1LB2LA2RA", 17, 6},
	{"1RB2LB0LB_2LA1RZ2RB", 17, 4},
	{"1RB2RA1RZ_0LB2RB1LA", 17, 3},
	// BB(2,4)
	{"1RB3LA1LA1RA_2LA1RZ3RA3RB", 7195, 90},
	{"1RB3LA1LA1RA_2LA1RZ3LA3RB", 6445, 84},
	{"1RB3LA1LA1RA_2LA1RZ2RA3RB", 6445, 84},
	{"1RB2RB3LA2RA_1LA3RB1RZ1LB", 2351, 60},
	{"1RB3RA1LA2RB_2LA3LA1RZ1RA", 1021, 53},
	{"1RB3LA1RZ0RB_2LB2LA0LA0RA", 1001, 26},
	{"1RB2LA1RZ3LA_2LA2RB3RB2LB", 770, 30},
	{"1RB2LB1RZ3LA_2LA2RB3RB2LB", 708, 29},
	{"1RB2LA0RB1LB_1LA3RA1RA1RZ", 592, 24},
	{"1RB3LA3RA0LA_2LB1LA1RZ2RA", 392, 20},
	{"1RB3LA1LA1RA_2LA1RZ2RB3RB", 376, 21},
	{"1RB3LA1LA1RA_2LA1RZ0LA3RB", 376, 21},
	{"1RB3LA3RB0LA_2LA1RZ1LB3RA", 374, 22},
	{"1RB1RA1LB0RA_2LA3RB2RA1RZ", 335, 18},
	{"1RB2LA3LA1LB_2LA1RZ2RB0RA", 292, 18},
	{"1RB0RB1RZ0LA_2LA3RA3LA1LB", 289, 13},
	{"1RB1LA1RZ0LB_2LA3RB1RB2RA", 283, 18},
	{"1RB3LA3RA0LA_2LB1LA1RZ3RA", 266, 19},
	{"1RB2RB1RZ1LB_2LA2LB3RB0RB", 241, 15},
	{"1RB2LA1RA1RA_1LB1LA3RB1RZ", 3932964, 2050},
	// BB(5)
	{"1RB1LC_1RC1RB_1RD0LE_1LA1LD_1RZ0LA", 47176870, 4098},
	{"1RB0LD_1LC1RD_1LA1LC_1RZ1RE_1RA0RB", 23554764, 4097},
	{"1RB1RA_1LC1LB_1RA0LD_0RB1LE_1RZ0RB", 11821234, 4097},
	{"1RB1RA_1LC1LB_1RA0LD_1RC1LE_1RZ0RB", 11821220, 4097},
	{"1RB1RA_0LC0RC_1RZ1RD_1LE0LA_1LA1LE", 11821190, 4096},
	{"1RB1RA_1LC0RD_1LA1LC_1RZ1RE_1LC0LA", 11815076, 4096},
	{"1RB1RA_1LC1LB_1RA0LD_0RB1LE_1RZ1LC", 11811040, 4097},
	{"1RB1RA_1LC1LB_0RC1LD_1RA0LE_1RZ1LC", 11811040, 4097},
	{"1RB1RA_1LC1LB_1RA0LD_1RC1LE_1RZ1LC", 11811026, 4097},
	{"1RB1RA_0LC0RC_1RZ1RD_1LE1RB_1LA1LE", 11811010, 4096},
	{"1RB1RA_1LC1LB_1RA1LD_0RE0LE_1RZ1LC", 11804940, 4097},
	{"1RB1RA_1LC1LB_1RA1LD_1RA0LE_1RZ1LC", 11804926, 4097},
	{"1RB1RA_1LC0RD_1LA1LC_1RZ1RE_0LE1RB", 11804910, 4096},
	{"1RB1RA_1LC0RD_1LA1LC_1RZ1RE_1LC1RB", 11804896, 4096},
	{"1RB1RA_1LC1LB_1RA1LD_1RA1LE_1RZ0LC", 11798826, 4098},
	{"1RB1RA_1LC1RD_1LA1LC_1RZ0RE_1LC1RB", 11798796, 4097},
	{"1RB1RA_1LC1RD_1LA1LC_1RZ1RE_0LE0RB", 11792724, 4097},
	{"1RB1RA_1LC1RD_1LA1LC_1RZ1RE_1LA0RB", 11792696, 4097},
	{"1RB1RA_1LC1RD_1LA1LC_1RZ1RE_1RA0RB", 11792682, 4097},
	{"1RB1RZ_1LC1RC_0RE0LD_1LC0LB_1RD1RA", 2358064,  1471},
};
const int N_TEST_CASES = sizeof TEST_CASES / sizeof *TEST_CASES;
